---
title: "Single-cell Visualizations"
subtitle: "Workshop on Advanced Data Visualization"
author: "Lokesh Mano"
format: 
    html:
        font-size: 10
code-annotations: hover
---

The visualization tutorila here is inspired from the [**NBIS workshop on Single-cell RNA-seq Analysis**](https://nbisweden.github.io/workshop-scRNAseq/). The visualization tutorial her eare part of the single-cell workshop as well.

# Get data

In this tutorial, we will run all tutorials with a set of 8 PBMC 10x datasets from 4 covid-19 patients and 4 healthy controls, the samples have been subsampled to 1500 cells per sample. We can start by defining our paths.

```{r, eval = FALSE, warning=FALSE, message=FALSE}
path_covid <- "./data/covid/"
if (!dir.exists(path_covid)) dir.create(path_covid, recursive = T)

download.file("https://lu.box.com/shared/static/205zwfegtinm49yuelbvxawln6r3wyjd", destfile = file.path(path_covid, "seurat_covid_raw.rds"))
download.file("https://lu.box.com/shared/static/nf5eps2uus9qcjx0ml0n313p9a8r1vb7", destfile = file.path(path_covid, "seurat_covid_qc_dr_clst.rds"))

# If downloading via R terminal fails, you can download the images directly using the following links:
# seurat_covid_raw.rds: https://lu.box.com/s/205zwfegtinm49yuelbvxawln6r3wyjd
# seurat_covid_qc_dr_clst.rds: https://lu.box.com/s/nf5eps2uus9qcjx0ml0n313p9a8r1vb7
```

With data in place, now we can start loading libraries we will use in this tutorial.

```{r, eval=FALSE, warning=FALSE, message=FALSE}
suppressPackageStartupMessages({
    library(Seurat)
    library(Matrix)
    library(ggplot2)
    library(patchwork)
    library(dplyr)
    library(tidyr)
})
seurat_covid_raw <- readRDS("./data/covid/seurat_covid_raw.rds")
```

```{r, eval=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
setwd("../topics/ggplot/")
covid_raw <- readRDS("./data/covid/seurat_covid_raw.rds")
covid_final <- readRDS("./data/covid/seurat_covid_qc_dr_clst.rds")
```

All the eight different datasets mentioned above are already merged into a single `Seurat` object. The two files you have downloaded are explained below:

 - `seurat_covid_raw.rds`: Contains all the data in raw format. There was no pre-processing of the data done here.
 - `seurat_covid_qc_dr_clst.rds`: In this file, the cells and the genes went through a different QC proces, followed by `Dimentionality Reduction` and `Clustering`.

# Raw data

Let us just take a look at the raw-data to satrt with. Here is how to take a look at the count matrix and the metadata for every cell.

```{r, eval=FALSE, warning=FALSE, message=FALSE}
# rna counts matrix
covid_raw[["RNA"]]$counts[1:10, 1:4] 

# metadat of the cells
head(covid_raw@meta.data, 10)
```

When you look at the metadata you can see the `rownames` are ids of each cell. Each of the column is explained below.

 - **orig.ident**: represents the patient id.
 - **nCount_RNA**: the total number of molecules detected within a cell
 - **nFeature_RNA**: the number of genes detected in each cell
 - **type**: If the sample is `covid` or `control`
 - **percent_mito**: Mitochondrial gene content in percent
 - **percent_ribo**: Ribosomal gene content in percent
 - **percent_hb**: Percentage hemoglobin genes
 - **percent_plat**: Percentage for some platelet markers

Thee values are pre-calculated to help assist with the visualization. 

## Plot QC

To plot the raw QC of the datset, we will use the function `VlnPlot()`. This is a function from the `Seurat` package and it basically generates a `ggplot2` object from the Seurat object. Violin plots are a different way of looking at `boxplot`. 

```{r, eval=FALSE, warning=FALSE, message=FALSE}
feats <- c("nFeature_RNA", "nCount_RNA", "percent_mito", "percent_ribo", "percent_hb", "percent_plat")
VlnPlot(covid_raw, group.by = "orig.ident", split.by = "type", features = feats, pt.size = 0.1, ncol = 3)
```

![](./images/raw_qc.png)

As you can see, there is quite some difference in quality for these samples, with for instance the covid_15 and covid_16 samples having cells with fewer detected genes and more mitochondrial content. As the ribosomal proteins are highly expressed they will make up a larger proportion of the transcriptional landscape when fewer of the lowly expressed genes are detected. We can also plot the different QC-measures as scatter plots.

```{r, eval=F}
FeatureScatter(covid_raw, "nCount_RNA", "nFeature_RNA", group.by = "orig.ident", pt.size = .5)
```

![](./images/raw_qc_scatter.png)

## Plot Genes

Extremely high number of detected genes could indicate doublets. However, depending on the cell type composition in your sample, you may have cells with higher number of genes (and also higher counts) from one cell type. Additionally, we can also see which genes contribute the most to such reads. We can for instance plot the percentage of counts per gene.

```{r, eval=FALSE, warning=FALSE, message=FALSE}
# Compute the proportion of counts of each gene per cell
# Use sparse matrix operations, if your dataset is large, doing matrix devisions the regular way will take a very long time.

C <- covid_raw[["RNA"]]$counts
C@x <- C@x / rep.int(colSums(C), diff(C@p)) * 100
most_expressed <- order(Matrix::rowSums(C), decreasing = T)[20:1]

most_exp_long <- as.data.frame(t(C[most_expressed, ])) %>%
    rownames_to_column(var = "Cell") %>%
    gather(Gene, count, -Cell)

ggplot(most_exp_long) +
    geom_boxplot(aes(factor(Gene, levels = row.names(C[most_expressed, ])), count, fill = factor(Gene, levels = row.names(C[most_expressed, ])))) +
    coord_flip() +
    ylab("Percent counts per cell") +
    xlab(("")) +
    theme_classic() +
    theme(legend.position = "none")
```
![](./images/raw_qc_high_gene.png)


:::{.callout-note}
The above plot and the code for the plot is very loaded. It is advised to go through them a bit carefully. 
:::

As you can see from the plot, the genes like `MALAT1`, the hameglobin gene `HBB` and `HBA2` and the several mitochondrial genes `MT-` are technical artifacts that needs to be removed. 

# Post filteration

There has been multiple filters applied to the above Seurat object containing raw data. Few of those are mentioned below:

 * cells with `nFeature_RNA > 200`
 * features with `rowSums(covid_raw[["RNA"]]$counts) > 3`
 * doublet prediction was applied for the cells and the doublets were removed.
 * `MALAT1`, `HB` and `MT-` genes were removed.

The filtered data is availbale in `covid_final`.

```{r, eval=FALSE, warning=FALSE, message=FALSE}
feats <- c("nFeature_RNA", "nCount_RNA", "percent_mito", "percent_ribo", "percent_hb", "percent_plat")
VlnPlot(covid_final, group.by = "orig.ident", split.by = "type", features = feats, pt.size = 0.1, ncol = 3)
```

![](./images/fil_qc.png)

We could also test the scatter plot to see how the `nCount_RNA` and `nFeature_RNA` are related in this filtered data compared to the raw data.

```{r, eval=FALSE, warning=FALSE, message=FALSE}
FeatureScatter(covid_final, "nCount_RNA", "nFeature_RNA", group.by = "orig.ident", pt.size = .5)
```
![](./images/fil_qc_scatter.png)

## Sample Sex

When working with human or animal samples, you should ideally constrain your experiments to a single sex to avoid including sex bias in the conclusions. However this may not always be possible. By looking at reads from chromosomeY (males) and XIST (X-inactive specific transcript) expression (mainly female) it is quite easy to determine per sample which sex it is. It can also be a good way to detect if there has been any mislabelling in which case, the sample metadata sex does not agree with the computational predictions.

For your convinience, the percentage of `ChrY` genes were calculated in each cell. These are present in the `covid_final` object. We can sanity check our samples by plotting both scatter plota and violon plots.

```{r, eval=FALSE, warning=FALSE, message=FALSE}
FeatureScatter(covid_final, feature1 = "XIST", feature2 = "pct_chrY", group.by = "orig.ident", pt.size = .5)
```
![](./images/fil_sex_scatter.png)

As you can see, the samples are clearly on either side, even if some cells do not have detection of either. Now let us plot this as violons to see which exact patients are Male and Female.

```{r, eval=FALSE, warning=FALSE, message=FALSE}
VlnPlot(covid_final, group.by = "orig.ident", split.by = "type", features = c("XIST", "pct_chrY"))
```
![](./images/fil_sex_vln.png)

You can clearly tell from the above image that the samples `covid_1`, `covid_17` and `ctrl_19` are `Male` and the rest are `Female`.
## Cell cycle state

The cell cycle state of each was determined using `CellCycleScoring()` function. Cell cycle scoring adds three slots in the metadata, a score for S phase, a score for G2M phase and the predicted cell cycle phase.

```{r, eval=FALSE, warning=FALSE, message=FALSE}
VlnPlot(covid_final, features = c("S.Score", "G2M.Score"), group.by = "orig.ident", ncol = 2, pt.size = .1)
```
![](./images/fil_cc_vln.png)

In this case it looks like we only have a few cycling cells in these datasets. We can also use the scatter plot and the prediction cell cycle phase.

```{r, eval=FALSE, warning=FALSE, message=FALSE}
FeatureScatter(covid_final, "S.Score", "G2M.Score", group.by = "Phase")
```
![](./images/fil_cc_scater.png)

These are all the `QC` checks one usually does on a single-cell analysis. Now, let us also comapre the number of cells present from each patient

```{r, eval=F}
> table(covid_raw$orig.ident)

 covid_1 covid_15 covid_16 covid_17  ctrl_13  ctrl_14  ctrl_19   ctrl_5 
    1500     1500     1500     1500     1500     1500     1500     1500 

> table(covid_final$orig.ident)

 covid_1 covid_15 covid_16 covid_17  ctrl_13  ctrl_14  ctrl_19   ctrl_5 
     875      549      357     1057     1126      996     1141     1033 
```










````{comment}
 - Open Dev container and work on this document from the container.
 - Save images and visualizations in a directory and then add them as static images.
 - This is to overcome the need to add the rds files to the repo or gh-action.
````

